
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>My GitHub README</title>
  <link rel="stylesheet" href="./static/styles.css" />
</head>
<body>
  <article>
    <p><strong>This v2Project is a demonstration of Using GraphQL with Django for the Time Clocking of Users.
A User can Clock In/Out, check total clocked Hours in the current Day/Week/Month.
All activites require a user to be authenticated using JWT.</strong></p>
<h1 id="setup">Setup</h1>
<p>1a. Install Insomnia Client using <code>https://insomnia.rest/</code>
We will use it to make queries to our GraphQL endpoint.</p>
<p>1b. Open up a Terminal and follow the commands</p>
<pre><code class="language-py">from airflow import DAG
from airflow.operators.python import PythonOperator
import pendulum
from airflow.models.taskinstance import TaskInstance as ti


def _transform(ti: ti):
    import requests
    resp = requests.get(f&#39;https://swapi.dev/api/people/1&#39;).json()
    print(resp)
    my_character = {}
    my_character[&quot;height&quot;] = int(resp[&quot;height&quot;]) - 20
    my_character[&quot;mass&quot;] = int(resp[&quot;mass&quot;]) - 13
    my_character[&quot;hair_color&quot;] = &quot;black&quot; if resp[&quot;hair_color&quot;] == &quot;blond&quot; else &quot;blond&quot;
    my_character[&quot;eye_color&quot;] = &quot;hazel&quot; if resp[&quot;eye_color&quot;] == &quot;blue&quot; else &quot;blue&quot;
    my_character[&quot;gender&quot;] = &quot;female&quot; if resp[&quot;gender&quot;] == &quot;male&quot; else &quot;female&quot;
    ti.xcom_push(&quot;character_info&quot;, my_character)

def _load(ti: ti):
    print(ti.xcom_pull(key = &#39;character_info&#39;,task_ids = [&#39;_transform&#39;]))

with DAG(
    &#39;xcoms_demo_1&#39;,
    schedule = None,
    start_date = pendulum.datetime(2023,3,1),
    catchup = False
):
    
    t1 = PythonOperator(
        task_id = &#39;_transform&#39;,
        python_callable = _transform
    )

    t2 = PythonOperator(
        task_id = &#39;load&#39;,
        python_callable = _load
    )

    t1 &gt;&gt; t2
</code></pre>
<h1 id="make-django-4x-changes-for-jwt">Make Django 4.x changes for JWT</h1>
<pre><code class="language-py">PYTHON_VERSION=&quot;$(python --version | cut -d &quot; &quot; -f 2 | cut -d &quot;.&quot; -f 1-2)&quot;
sudo rm -r $(pwd)/venv/lib/python$PYTHON_VERSION/site-packages/graphql_jwt -f
cp modules/graphql_jwt $(pwd)/venv/lib/python$PYTHON_VERSION/site-packages/ -r
</code></pre>
<h1 id="setup-database">Setup Database</h1>
<pre><code class="language-py">python3 manage.py makemigrations timeclock
python3 manage.py makemigrations
python3 manage.py migrate
python3 manage.py createsuperuser
</code></pre>
<h1 id="start-server">Start Server</h1>
<pre><code class="language-py">python3 manage.py runserver
</code></pre>
<p>Access API at <code>http://127.0.0.1:8000/graphql/</code></p>
<h1 id="create-account">Create Account</h1>
<pre><code class="language-py">mutation{
  createUser(
    username: &quot;user123&quot;
    email: &quot;user123@user.com&quot;
    password1: &quot;!@#qwe!@#qwe&quot;
    password2: &quot;!@#qwe!@#qwe&quot;
  ){
    success
    errors
  }
}
</code></pre>
<p>Copy the Activation Token as displayed on the terminal. This is to verify a User Account.</p>
<p><img src="./images/VerifyToken.png" alt="alt text"></p>
<h1 id="activate-account">Activate account</h1>
<p>Use your previously copied <strong>Activation Token</strong> from <code> http://127.0.0.1:8000/activate/YOUR_TOKEN</code> in the Query</p>
<pre><code class="language-py">mutation{
  verifyAccount(
      token:&quot;YOUR_TOKEN&quot;
  ){
    success
    errors
  }
}
</code></pre>
<h1 id="obtain-jwt-token">Obtain JWT Token</h1>
<pre><code class="language-py">mutation{
  obtainToken(username:&quot;user123&quot;,
  password:&quot;!@#qwe!@#qwe&quot;){
    token
  }
}
</code></pre>
<p>Copy the <strong>JWT Token</strong> in the Response. we will use it for the following query authentication.</p>
<h1 id="use-insomnia-api-client-to-test-the-api">Use Insomnia API CLient to test the API</h1>
<ul>
<li>In your environment, add your token to use as variable <code>_.TOKEN</code> in the following queries</li>
</ul>
<pre><code class="language-py">{
    &quot;TOKEN&quot;: &quot;YOUR_JWT_TOKEN&quot;
}
</code></pre>
<p><img src="./images/Insomnia.png" alt="alt text"></p>
<ul>
<li>Create the following queries by setting body as <code>GraphQL Query</code></li>
<li>In the Header, set <ul>
<li><code>Content-Type</code>  : <code>application/json</code></li>
<li><code>Authorization</code> : <code>JWT _.TOKEN</code></li>
</ul>
</li>
</ul>
<p><img src="./images/Queries.png" alt="alt text"></p>
<h1 id="me">Me</h1>
<pre><code class="language-py">query{
  me{
    username
    email
  }
}
</code></pre>
<h1 id="clockin">ClockIn</h1>
<pre><code class="language-py">mutation{
  clockIn{
    clock{
      clockedIn
      clockedOut
    }
  }
}
</code></pre>
<h1 id="currentclock">CurrentClock</h1>
<pre><code class="language-py">query{
  currentClock{
    clockedIn
    clockedOut
  }
}
</code></pre>
<h1 id="clockout">ClockOut</h1>
<pre><code class="language-py">mutation{
  clockOut{
    clock{
      clockedIn
      clockedOut
    }
  }
}
</code></pre>
<h1 id="clockedhours">ClockedHours</h1>
<pre><code class="language-py">query{
  clockedHours
}
</code></pre>
<p><img src="./images/ClockedHours.png" alt="alt text"></p>
<h1 id="django-admin">Django Admin</h1>
<p>You can also add Data for testing using the Django admin.
Go to <code>http://127.0.0.1:8000/admin/</code> and login using your superuser credentials
<img src="./images/Djangoadmin.png" alt="alt text"></p>

  </article>
  <script src="./static/script.js"></script>
</body>
</html>
